#!/usr/bin/env bash

set -e

VERSION="1.0.0"
CONFIG_FILE="$HOME/.config/gh-ext-manage/config.json"

# è¨€èªè¨­å®šã®æ¤œå‡º
detect_language() {
    local lang="${LANG:-${LC_ALL:-en_US.UTF-8}}"
    case "$lang" in
        ja_JP*|ja-JP*|ja*) echo "ja" ;;
        *) echo "en" ;;
    esac
}

LANGUAGE=$(detect_language)

# ã‚«ãƒ©ãƒ¼è¨­å®š
if [[ -t 1 ]] && command -v tput >/dev/null 2>&1; then
    RED=$(tput setaf 1)
    GREEN=$(tput setaf 2)
    YELLOW=$(tput setaf 3)
    BLUE=$(tput setaf 4)
    CYAN=$(tput setaf 6)
    BOLD=$(tput bold)
    RESET=$(tput sgr0)
else
    RED=""
    GREEN=""
    YELLOW=""
    BLUE=""
    CYAN=""
    BOLD=""
    RESET=""
fi

# å¤šè¨€èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
get_message() {
    local key="$1"
    case "$LANGUAGE" in
        "ja")
            case "$key" in
                "missing_deps") echo "âŒ å¿…è¦ãªä¾å­˜é–¢ä¿‚ãŒä¸è¶³ã—ã¦ã„ã¾ã™:" ;;
                "missing_deps_footer") echo "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚" ;;
                "installed_extensions") echo "ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿GitHub CLIæ‹¡å¼µ" ;;
                "no_extensions_installed") echo "âš ï¸  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹æ‹¡å¼µãŒã‚ã‚Šã¾ã›ã‚“" ;;
                "repository") echo "ğŸ“ ãƒªãƒã‚¸ãƒˆãƒª:" ;;
                "commit") echo "ğŸ†” ã‚³ãƒŸãƒƒãƒˆ:" ;;
                "installing_extensions") echo "ğŸ“¥ æ‹¡å¼µã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™" ;;
                "no_extensions_in_config") echo "âš ï¸  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ‹¡å¼µãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“" ;;
                "config_file") echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:" ;;
                "repo_not_specified") echo "âŒ ãƒªãƒã‚¸ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹¡å¼µã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ" ;;
                "already_installed") echo "â­ï¸  %s ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™" ;;
                "installing") echo "ğŸ“¦ %s ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..." ;;
                "install_success") echo "âœ… %s ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ" ;;
                "install_failed") echo "âŒ %s ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ" ;;
                "install_summary") echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†: %då€‹ã®æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«, %då€‹ã‚’ã‚¹ã‚­ãƒƒãƒ—" ;;
                "syncing_extensions") echo "ğŸ”„ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæœŸã—ã¾ã™" ;;
                "no_extensions_to_sync") echo "âš ï¸  åŒæœŸã™ã‚‹æ‹¡å¼µãŒã‚ã‚Šã¾ã›ã‚“" ;;
                "sync_success") echo "âœ… %då€‹ã®æ‹¡å¼µã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæœŸã—ã¾ã—ãŸ" ;;
                "updating_extension") echo "â¬†ï¸  æ‹¡å¼µ '%s' ã‚’æ›´æ–°ã—ã¾ã™" ;;
                "update_success") echo "âœ… %s ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ" ;;
                "update_failed") echo "âŒ %s ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" ;;
                "updating_all") echo "â¬†ï¸  å…¨ã¦ã®æ‹¡å¼µã‚’æ›´æ–°ã—ã¾ã™" ;;
                "update_all_success") echo "âœ… å…¨ã¦ã®æ‹¡å¼µã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ" ;;
                "update_all_failed") echo "âŒ æ‹¡å¼µã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" ;;
                "no_command") echo "âŒ ã‚³ãƒãƒ³ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" ;;
                "unknown_command") echo "âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: %s" ;;
                *) echo "$key" ;;
            esac
            ;;
        *)
            case "$key" in
                "missing_deps") echo "âŒ Missing required dependencies:" ;;
                "missing_deps_footer") echo "Please install the dependencies and try again." ;;
                "installed_extensions") echo "ğŸ“¦ Installed GitHub CLI Extensions" ;;
                "no_extensions_installed") echo "âš ï¸  No extensions are installed" ;;
                "repository") echo "ğŸ“ Repository:" ;;
                "commit") echo "ğŸ†” Commit:" ;;
                "installing_extensions") echo "ğŸ“¥ Starting extension installation" ;;
                "no_extensions_in_config") echo "âš ï¸  No extensions defined in configuration file" ;;
                "config_file") echo "Configuration file:" ;;
                "repo_not_specified") echo "âŒ Skipped extension with no repository specified" ;;
                "already_installed") echo "â­ï¸  %s is already installed" ;;
                "installing") echo "ğŸ“¦ Installing %s..." ;;
                "install_success") echo "âœ… Successfully installed %s" ;;
                "install_failed") echo "âŒ Failed to install %s" ;;
                "install_summary") echo "Installation complete: %d extensions installed, %d skipped" ;;
                "syncing_extensions") echo "ğŸ”„ Syncing installed extensions to configuration file" ;;
                "no_extensions_to_sync") echo "âš ï¸  No extensions to sync" ;;
                "sync_success") echo "âœ… Synced %d extensions to configuration file" ;;
                "updating_extension") echo "â¬†ï¸  Updating extension '%s'" ;;
                "update_success") echo "âœ… Successfully updated %s" ;;
                "update_failed") echo "âŒ Failed to update %s" ;;
                "updating_all") echo "â¬†ï¸  Updating all extensions" ;;
                "update_all_success") echo "âœ… Successfully updated all extensions" ;;
                "update_all_failed") echo "âŒ Error occurred while updating extensions" ;;
                "no_command") echo "âŒ No command specified" ;;
                "unknown_command") echo "âŒ Unknown command: %s" ;;
                *) echo "$key" ;;
            esac
            ;;
    esac
}

# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
check_dependencies() {
    local missing_deps=()
    
    if ! command -v gh >/dev/null 2>&1; then
        missing_deps+=("gh (GitHub CLI)")
    fi
    
    if ! command -v jq >/dev/null 2>&1; then
        missing_deps+=("jq")
    fi
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo "${RED}$(get_message "missing_deps")${RESET}"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
        echo ""
        get_message "missing_deps_footer"
        exit 1
    fi
}

# è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
init_config() {
    local config_dir
    config_dir=$(dirname "$CONFIG_FILE")
    
    if [[ ! -d "$config_dir" ]]; then
        mkdir -p "$config_dir"
    fi
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
{
  "extensions": []
}
EOF
    fi
}

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µã®ä¸€è¦§è¡¨ç¤º
cmd_list() {
    echo "${BLUE}$(get_message "installed_extensions")${RESET}"
    echo ""
    
    local extensions
    extensions=$(gh extension list 2>/dev/null || true)
    
    if [[ -z "$extensions" ]]; then
        echo "${YELLOW}$(get_message "no_extensions_installed")${RESET}"
        return 0
    fi
    
    echo "$extensions" | while IFS=$'\t' read -r name repo commit; do
        if [[ -n "$name" ]]; then
            echo "${GREEN}${BOLD}$name${RESET}"
            echo "  $(get_message "repository") $repo"
            echo "  $(get_message "commit") $commit"
            echo ""
        fi
    done
}

# æ‹¡å¼µã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cmd_install() {
    init_config
    
    echo "${BLUE}$(get_message "installing_extensions")${RESET}"
    echo ""
    
    local extensions
    extensions=$(jq -r '.extensions[]' "$CONFIG_FILE" 2>/dev/null || echo "")
    
    if [[ -z "$extensions" ]]; then
        echo "${YELLOW}$(get_message "no_extensions_in_config")${RESET}"
        echo "$(get_message "config_file") $CONFIG_FILE"
        return 0
    fi
    
    local installed_count=0
    local skipped_count=0
    local temp_file="/tmp/gh-ext-manage-counts.$$"
    echo "0 0" > "$temp_file"
    
    echo "$extensions" | jq -r '. | @json' | while read -r ext_json; do
        local repo
        
        repo=$(echo "$ext_json" | jq -r '.repo // empty')
        
        if [[ -z "$repo" ]]; then
            echo "${RED}$(get_message "repo_not_specified")${RESET}"
            continue
        fi
        
        local ext_name
        ext_name=$(basename "$repo" | sed 's/^gh-//')
        
        # æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if gh extension list | grep -q "$ext_name"; then
            printf "%s\n" "${YELLOW}$(get_message "already_installed" | sed "s/%s/$ext_name/g")${RESET}"
            read -r installed_count skipped_count < "$temp_file"
            echo "$installed_count $((skipped_count + 1))" > "$temp_file"
            continue
        fi
        
        printf "%s\n" "${CYAN}$(get_message "installing" | sed "s/%s/$repo/g")${RESET}"
        
        if gh extension install "$repo"; then
            printf "%s\n" "${GREEN}$(get_message "install_success" | sed "s/%s/$ext_name/g")${RESET}"
            read -r installed_count skipped_count < "$temp_file"
            echo "$((installed_count + 1)) $skipped_count" > "$temp_file"
        else
            printf "%s\n" "${RED}$(get_message "install_failed" | sed "s/%s/$ext_name/g")${RESET}"
        fi
        echo ""
    done
    
    read -r installed_count skipped_count < "$temp_file"
    rm -f "$temp_file"
    
    printf "%s\n" "${GREEN}${BOLD}$(get_message "install_summary" | sed "s/%s/$installed_count/" | sed "s/%s/$skipped_count/")${RESET}"
}

# æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‹¡å¼µã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸ
cmd_sync() {
    init_config
    
    echo "${BLUE}$(get_message "syncing_extensions")${RESET}"
    echo ""
    
    local extensions
    extensions=$(gh extension list 2>/dev/null || true)
    
    if [[ -z "$extensions" ]]; then
        echo "${YELLOW}$(get_message "no_extensions_to_sync")${RESET}"
        return 0
    fi
    
    local repos=()
    while IFS=$'\t' read -r name repo commit; do
        if [[ -n "$name" && -n "$repo" ]]; then
            repos+=("$repo")
        fi
    done <<< "$extensions"
    
    local config_json='{"extensions":['
    local first=true
    
    for repo in "${repos[@]}"; do
        if [[ "$first" == "true" ]]; then
            first=false
        else
            config_json+=','
        fi
        config_json+="{\"repo\":\"$repo\"}"
    done
    config_json+=']}'
    
    echo "$config_json" | jq '.' > "$CONFIG_FILE"
    
    printf "%s\n" "${GREEN}$(get_message "sync_success" | sed "s/%s/${#repos[@]}/g")${RESET}"
    echo "$(get_message "config_file") $CONFIG_FILE"
}

# æ‹¡å¼µã®æ›´æ–°
cmd_update() {
    local target_extension="$1"
    
    if [[ -n "$target_extension" ]]; then
        printf "%s\n" "${BLUE}$(get_message "updating_extension" | sed "s/%s/$target_extension/g")${RESET}"
        echo ""
        
        if gh extension upgrade "$target_extension"; then
            printf "%s\n" "${GREEN}$(get_message "update_success" | sed "s/%s/$target_extension/g")${RESET}"
        else
            printf "%s\n" "${RED}$(get_message "update_failed" | sed "s/%s/$target_extension/g")${RESET}"
            exit 1
        fi
    else
        echo "${BLUE}$(get_message "updating_all")${RESET}"
        echo ""
        
        if gh extension upgrade --all; then
            echo "${GREEN}$(get_message "update_all_success")${RESET}"
        else
            echo "${RED}$(get_message "update_all_failed")${RESET}"
            exit 1
        fi
    fi
}

# ãƒ˜ãƒ«ãƒ—ã®è¡¨ç¤º
cmd_help() {
    if [[ "$LANGUAGE" == "ja" ]]; then
        cat << EOF
${BOLD}GitHub CLI Extension Manager${RESET} - GitHub CLIæ‹¡å¼µã‚’ç°¡å˜ã«ç®¡ç†

${BOLD}ä½¿ç”¨æ–¹æ³•:${RESET}
  gh ext-manage <ã‚³ãƒãƒ³ãƒ‰> [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

${BOLD}ã‚³ãƒãƒ³ãƒ‰:${RESET}
  ${GREEN}list${RESET}              ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µã®ä¸€è¦§è¡¨ç¤º
  ${GREEN}install${RESET}           è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ‹¡å¼µã‚’ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  ${GREEN}sync${RESET}              æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‹¡å¼µã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæœŸ
  ${GREEN}update${RESET} [æ‹¡å¼µå]    æ‹¡å¼µã®æ›´æ–°ï¼ˆæ‹¡å¼µåçœç•¥æ™‚ã¯å…¨ã¦æ›´æ–°ï¼‰
  ${GREEN}help${RESET}              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  ${GREEN}version${RESET}           ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º

${BOLD}è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:${RESET}
  $CONFIG_FILE

${BOLD}è¨­å®šä¾‹:${RESET}
  {
    "extensions": [
      {"repo": "cli/gh-copilot"},
      {"repo": "github/gh-actions"},
      {"repo": "dlvhdr/gh-dash", "alias": "dashboard"}
    ]
  }

${BOLD}ä¾å­˜é–¢ä¿‚:${RESET}
  - GitHub CLI (gh)
  - jq

GitHub: https://github.com/sh05/gh-ext-manage
EOF
    else
        cat << EOF
${BOLD}GitHub CLI Extension Manager${RESET} - Declarative management of GitHub CLI extensions

${BOLD}Usage:${RESET}
  gh ext-manage <command> [options]

${BOLD}Commands:${RESET}
  ${GREEN}list${RESET}              List installed extensions
  ${GREEN}install${RESET}           Install extensions from configuration file
  ${GREEN}sync${RESET}              Sync manually installed extensions to config
  ${GREEN}update${RESET} [name]     Update extensions (all if name omitted)
  ${GREEN}help${RESET}              Show this help
  ${GREEN}version${RESET}           Show version information

${BOLD}Configuration File:${RESET}
  $CONFIG_FILE

${BOLD}Example Configuration:${RESET}
  {
    "extensions": [
      {"repo": "cli/gh-copilot"},
      {"repo": "github/gh-actions"},
      {"repo": "dlvhdr/gh-dash", "alias": "dashboard"}
    ]
  }

${BOLD}Dependencies:${RESET}
  - GitHub CLI (gh)
  - jq

GitHub: https://github.com/sh05/gh-ext-manage
EOF
    fi
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®è¡¨ç¤º
cmd_version() {
    echo "${BOLD}gh-ext-manage${RESET} version $VERSION"
    echo ""
    echo "GitHub CLI Extension Manager"
    echo "Copyright (c) 2024"
    echo "MIT License"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    check_dependencies
    
    case "${1:-}" in
        "list")
            cmd_list
            ;;
        "install")
            cmd_install
            ;;
        "sync")
            cmd_sync
            ;;
        "update")
            cmd_update "$2"
            ;;
        "help"|"--help"|"-h")
            cmd_help
            ;;
        "version"|"--version"|"-v")
            cmd_version
            ;;
        "")
            echo "${RED}$(get_message "no_command")${RESET}"
            echo ""
            cmd_help
            exit 1
            ;;
        *)
            printf "%s\n" "${RED}$(get_message "unknown_command" | sed "s/%s/$1/g")${RESET}"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"